# ------------------------------------------------------------------
# State machines actions for command menu
#
# note that we now try to update if the co fails

set machine1 {
    {init   		all 	"cd %d; cvs co -r %V -d %T -A %P"}
    {cvs-co-Failed	async	"cd %D; cvs update -d"}
    {cvs-co-OK		async 	"cd %D; cvs -H update"}
    {cvs-update-OK	async 	"cd %D; cvs upd -A"}
    {cvs-upd-OK		turns 	"cd %D; make declare"}
    {make-declare-OK	async	"cd %D; set +x; setup -q build -f %F %P %V; set -x"}
    {set-+x-OK		async	"cd %D; make all"}
    {make-all-OK	async	"cd %D; make test"}
}

set machine2 {
    {init		all	"cd %D; set +x; setup -q build -f %F %P %V; set -x"}
    {set-+x-OK		async	"cd %D; make all"}
    {make-all-OK	async	"cd %D; make test"}
}

# note that we now try to update if the co fails
set machine3 {
    {init   		all 	"cd %d; cvs co -r %V -d %T -A %P"}
    {cvs-co-Failed	async	"cd %D; cvs update -d"}
    {cvs-co-OK		turns 	"cd %D; cvs -H update"}
    {cvs-update-OK	async 	"cd %D; cvs upd -A"}
    {cvs-upd-OK		turns 	"cd %D; make declare"}
    {make-declare-OK	async	"cd %D; set +x; setup -q build -f %F %P %V; set -x"}
    {set-+x-OK		async	"cd %D; make all"}
    {make-all-OK	async	"cd %D; make test"}
    {make-test-OK	async	"cd %D; make clean"}
    {make-clean-OK	async	"cd %D; make auto%R"}
    {make-autokits-Question-1	
			turns	"y"}
    {make-local-OK	async	"cd %d; cvs release -d %T"}
    {make-kits-OK	async	"cd %d; cvs release -d %T"}
    {cvs-release-Question-1 async "y"}
}

set fastrelease {
    {init			all	"(cd %D; make auto%R)"}
    {make-autokits-Question-1	turns	"y"}
}

array set cmd_menu {
    { 1 cd}	 	  {cmd_parallel  "cd %D"}
    { 2 cvs checkout}	  {cmd_parallel  "cd %d; cvs co -r %V -d %T -A %P" }
    { 3 make declare}	  {cmd_taketurns "(cd %D; make declare)"}
    { 4 setup}	  	  {cmd_parallel  "set +x;setup -q build -f %F %P %V;set -x"}
    { 5 make all}	  {cmd_parallel  "(cd %D; make all)"}
    { 6 make test}	  {cmd_parallel  "(cd %D; make test)"}
    { 7 make clean}	  {cmd_parallel  "(cd %D; make clean)"}
    { 8 make local|kits}  {cmd_machine $fastrelease}
    { 9 cvs release}	  {cmd_parallel  "cd %d; cvs release -d %T"}
    {10 auto 1..6}	  {cmd_machine $machine1}
    {11 auto 4..6}	  {cmd_machine $machine2}
    {12 auto 1..9}	  {cmd_machine $machine3}
    {13 cvs update}	  {cmd_parallel "(cd %D; cvs update -d)"}
    {14 cvs update -A}	  {cmd_parallel "(cd %D; cvs update -A)"}
    {clear auto}	  {clear_statepending}
    {interrupt}	  	  {cmd_parallel  "\x003"}
    {exit} 		  {cmd_parallel  "exit"; after 5000 exit}
}
